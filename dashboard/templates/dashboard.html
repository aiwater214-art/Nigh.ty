{% extends "base.html" %}
{% block content %}
<div class="level">
  <div class="level-left">
    <div>
      <h1 class="title">Welcome, {{ user.full_name or user.username }}!</h1>
      <p class="subtitle">You joined on {{ user.created_at.strftime('%Y-%m-%d') }}</p>
    </div>
  </div>
  <div class="level-right">
    {% if user.is_admin %}
    <a class="button is-info mr-2" href="/dashboard/admin">Admin</a>
    {% endif %}
    <a class="button is-light" href="/dashboard/logout">Log out</a>
  </div>
</div>

<div class="columns">
  <div class="column">
    <div class="box">
      <h2 class="title is-5">Your Stats</h2>
      <ul>
        <li><strong>Cells eaten:</strong> <span data-user-stat="cells_eaten">{{ (stats and stats.cells_eaten) or 0 }}</span></li>
        <li><strong>Food eaten:</strong> <span data-user-stat="food_eaten">{{ (stats and stats.food_eaten) or 0 }}</span></li>
        <li><strong>Worlds explored:</strong> <span data-user-stat="worlds_explored">{{ (stats and stats.worlds_explored) or 0 }}</span></li>
        <li><strong>Sessions played:</strong> <span data-user-stat="sessions_played">{{ (stats and stats.sessions_played) or 0 }}</span></li>
      </ul>
    </div>
  </div>
  <div class="column">
    <div class="box">
      <h2 class="title is-5">Global Metrics</h2>
      <ul>
        <li><strong>Cells eaten:</strong> <span data-total-stat="cells_eaten">{{ totals.cells_eaten }}</span></li>
        <li><strong>Food eaten:</strong> <span data-total-stat="food_eaten">{{ totals.food_eaten }}</span></li>
        <li><strong>Worlds explored:</strong> <span data-total-stat="worlds_explored">{{ totals.worlds_explored }}</span></li>
        <li><strong>Sessions played:</strong> <span data-total-stat="sessions_played">{{ totals.sessions_played }}</span></li>
      </ul>
    </div>
  </div>
</div>

<div class="box">
  <h2 class="title is-5">Worlds</h2>
  <p class="mb-3">
    <strong>Gameplay configuration:</strong>
    {{ config.width }}Ã—{{ config.height }} arena,
    tick rate {{ config.tick_rate }} Hz,
    {{ config.food_count }} food nodes,
    snapshots every {{ config.snapshot_interval }}s.
  </p>
  {% if worlds %}
  <table class="table is-fullwidth">
    <thead>
      <tr>
        <th>Name</th>
        <th>Description</th>
        <th>Active players</th>
        <th>Created at</th>
      </tr>
    </thead>
    <tbody>
      {% for world in worlds %}
      <tr>
        <td>{{ world.name }}</td>
        <td>{{ world.description }}</td>
        <td>{{ world.active_players }}</td>
        <td>{{ world.created_at.strftime('%Y-%m-%d') }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p>No worlds registered yet.</p>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const userStatsEls = {
      cells_eaten: document.querySelector('[data-user-stat="cells_eaten"]'),
      food_eaten: document.querySelector('[data-user-stat="food_eaten"]'),
      worlds_explored: document.querySelector('[data-user-stat="worlds_explored"]'),
      sessions_played: document.querySelector('[data-user-stat="sessions_played"]'),
    };
    const totalEls = {
      cells_eaten: document.querySelector('[data-total-stat="cells_eaten"]'),
      food_eaten: document.querySelector('[data-total-stat="food_eaten"]'),
      worlds_explored: document.querySelector('[data-total-stat="worlds_explored"]'),
      sessions_played: document.querySelector('[data-total-stat="sessions_played"]'),
    };

    const streamUrl = {{ stats_stream_url|tojson }};
    const source = new EventSource(streamUrl);

    const applyValues = (elements, values = {}) => {
      Object.entries(elements).forEach(([key, el]) => {
        if (!el || !(key in values)) {
          return;
        }
        el.textContent = values[key];
        el.classList.add("has-text-weight-semibold");
        setTimeout(() => el.classList.remove("has-text-weight-semibold"), 600);
      });
    };

    source.addEventListener("stats", (event) => {
      try {
        const payload = JSON.parse(event.data);
        if (payload.totals) {
          applyValues(totalEls, payload.totals);
        }
        if (payload.stats) {
          applyValues(userStatsEls, payload.stats);
        }
      } catch (err) {
        console.error("Failed to parse stats payload", err);
      }
    });

    source.onerror = () => {
      console.warn("Stats stream disconnected, retrying soon...");
    };

    window.addEventListener("beforeunload", () => source.close());
  });
</script>
{% endblock %}
